{% extends "base.html" %}

{% block title %}Admin Panel{% endblock %}

{% block content %}
<div class="terminal-box">
  <h1>System Administration</h1>
  <p style="color: var(--text-dim);">// Manage users, roles and system configuration</p>
</div>

{% if nuki_batteries %}
<div class="terminal-box">
  <h2>Nuki Status</h2>
  <table>
    <thead>
      <tr>
        <th>Door</th>
        <th>MAC</th>
        <th>Battery</th>
        <th>Unlatch</th>
        <th>Last Check</th>
      </tr>
    </thead>
    <tbody>
      {% for nuki in nuki_batteries %}
      <tr>
        <td><strong>{{ nuki.name }}</strong></td>
        <td><code style="font-size: 11px;">{{ nuki.mac }}</code></td>
        <td>
          {% if nuki.battery.critical %}
            <span style="color: var(--terminal-red);">⚠️ CRITICAL</span>
          {% else %}
            <span style="color: var(--terminal-green);">✓ OK</span>
          {% endif %}
        </td>
        <td>
          {% if nuki.unlatch_allowed %}
            <span style="color: var(--terminal-green);">✓ Enabled</span>
          {% else %}
            <span style="color: var(--text-dim);">✗ Disabled</span>
          {% endif %}
        </td>
        <td style="color: var(--text-dim); font-size: 12px;">
          {{ nuki.battery.timestamp or '-' }}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endif %}

<div class="terminal-box">
  <h2>User Management</h2>

  <form method="post" action="{{ url_for('admin.update_user_roles') }}">
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>E-Mail</th>
          <th>Username</th>
          <th>Status</th>
          <th>Roles</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for u in users %}
          <tr>
            <td><code>{{ u.id }}</code></td>
            <td>{{ u.email }}</td>
            <td>{{ u.username or '-' }}</td>
            <td>
              {% if u.active %}
                <span class="status-badge active">ACTIVE</span>
              {% else %}
                <span class="status-badge inactive">INACTIVE</span>
              {% endif %}
            </td>
            <td>
              {% if all_roles %}
                {% for role in all_roles %}
                  <label style="display:inline-block; margin-right:10px; cursor: pointer;">
                    <input type="checkbox"
                           name="roles_{{ u.id }}"
                           value="{{ role.name }}"
                           {% if role in u.roles %}checked{% endif %}
                           {% if role.name == 'admin' and u.id == current_user.id %}disabled{% endif %}
                    >
                    <span class="role-tag {% if role.name == 'admin' %}admin{% endif %}">{{ role.name }}</span>
                  </label>
                {% endfor %}
              {% else %}
                <em style="color: var(--text-dim);">No roles defined</em>
              {% endif %}
            </td>
            <td>
              {% if u.id != current_user.id %}
                <form method="post"
                      action="{{ url_for('admin.delete_user', user_id=u.id) }}"
                      onsubmit="return confirm('Delete user {{ u.email }}?');"
                      style="display: inline;">
                  <button type="submit" class="danger">Delete</button>
                </form>
              {% else %}
                <em style="color: var(--text-dim);">Current user</em>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    {% if all_roles %}
      <div style="margin-top: 20px;">
        <button type="submit">Save Role Changes</button>
      </div>
    {% endif %}
  </form>
</div>

<div class="terminal-box">
  <h2>Create New User</h2>
  <form method="post" action="{{ url_for('admin.create_user') }}" style="max-width: 600px;">
    <div>
      <label>E-Mail Address:</label>
      <input name="email" type="email" required placeholder="user@example.com">
    </div>

    <div>
      <label>Username (Optional):</label>
      <input name="username" type="text" placeholder="username">
    </div>

    <div>
      <label style="display: flex; align-items: center; cursor: pointer;">
        <input type="checkbox" name="is_admin">
        <span style="margin-left: 8px;">Grant Admin Role</span>
      </label>
    </div>

    <button type="submit">Create User & Send Password</button>
    <p style="color: var(--text-dim); font-size: 12px; margin-top: 10px;">
      // A random password will be generated and sent via email
    </p>
  </form>
</div>
{% endblock %}
